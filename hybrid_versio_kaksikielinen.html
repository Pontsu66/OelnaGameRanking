<!DOCTYPE html>
<html lang="fi">
<head>
  <meta charset="UTF-8" />
  <title>Pelirankkaus – Hybrid_Versio</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #111;
      color: #eee;
      text-align: center;
      padding: 40px;
    }
    h1 { margin-bottom: 10px; }
    .buttons {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 40px;
      flex-wrap: wrap;
    }
    button {
      background: #222;
      color: #fff;
      border: 2px solid #444;
      padding: 20px 30px;
      font-size: 18px;
      cursor: pointer;
      border-radius: 10px;
      width: 250px;
      height: 80px;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      white-space: normal;
      word-wrap: break-word;
    }
    button:hover { background: #333; }
    #battleNumber { margin-top: 20px; font-size: 18px; }
    #instructions { margin-bottom: 20px; font-size: 16px; }
    #removedCount { margin-top: 10px; font-size: 16px; color: #ff5555; }
    #langSelect { margin-bottom: 30px; }
  </style>
</head>
<body>

<h1>Pelirankkaus – Hybrid_Versio</h1>
<div id="langSelect">
  Select language: 
  <button id="fiBtn">Suomi</button>
  <button id="enBtn">English</button>
</div>

<div id="instructions" style="display:none;"></div>
<div class="buttons" style="display:none;">
  <button id="leftBtn"></button>
  <button id="tieBtn"></button>
  <button id="rightBtn"></button>
</div>

<div id="battleNumber" style="display:none;"></div>
<div id="progress" style="margin-top:30px;font-size:18px;"></div>
<div id="removedCount" style="display:none;"></div>

<script>
const LANG_TEXTS = {
  fi: {
    instructions: 'Klikkaa peliä, joka on parempi!<br>Jos et voi valita, klikkaa "Molemmat yhtä hyviä".',
    tieBtn: 'Molemmat yhtä hyviä',
    removed: 'Poistettu pelejä',
    battle: 'Battle no.',
    progress: 'Ranking valmis noin',
    finalRanking: 'Loppuranking'
  },
  en: {
    instructions: 'Click on the game you like more!<br>If you can’t decide, click "I feel the same way about both".',
    tieBtn: 'I feel the same way about both',
    removed: 'Removed games',
    battle: 'Battle no.',
    progress: 'Ranking approximately',
    finalRanking: 'Final Ranking'
  }
};

let LANG = 'fi';

document.getElementById('fiBtn').onclick = () => setLanguage('fi');
document.getElementById('enBtn').onclick = () => setLanguage('en');

function setLanguage(lang) {
  LANG = lang;
  document.getElementById('langSelect').style.display = 'none';
  document.getElementById('instructions').style.display = 'block';
  document.querySelector('.buttons').style.display = 'flex';
  document.getElementById('battleNumber').style.display = 'block';
  document.getElementById('removedCount').style.display = 'block';
  document.getElementById('instructions').innerHTML = LANG_TEXTS[LANG].instructions;
  document.getElementById('tieBtn').textContent = LANG_TEXTS[LANG].tieBtn;
  showPair();
  updateProgress();
}

// --- Peli alkaa sama kuin Hybrid_Versio ---
const EXPLORATION_ROUNDS = 80;
const MAX_CHAMPION_REPEAT = 5;
const REMOVAL_THRESHOLD = 0.3;
const FINAL_BATTLE_START = 0.7;
const MAX_VOTES = 350;
const MIN_VOTES = 200;
const TOP_PROTECTED = 10;

const games = [
"Clair Obscur: Expedition 33","Kingdom Come: Deliverance 2","Undertale","Deltarune","Portal 2","Silent Hill 2","Assassin's Creed II","Assassin's Creed IV: Black Flag","Chrono Trigger","Alan Wake","Fable","Minecraft","Astro Bot","Life is Strange","Stalker: Shadow of Chernobyl","Stalker 2: Heart of Chernobyl","Stalker: Call of Pripyat","Phoenix Wright: Ace Attorney","Stardew Valley","The Binding of Isaac: Rebirth","Pokemon Gold/Silver/Crystal","Pokemon Black 2/White 2","Pokemon Ruby/Sapphire/Emerald","Pokemon HeartGold/SoulSilver","Bloodborne","Batman: Arkham City","Castlevania: Symphony of the Night","Grand Theft Auto: San Andreas","Grand Theft Auto: Vice City","Grand Theft Auto 5","The Legend of Zelda: A Link to the Past","The Legend of Zelda: Breath of the Wild","The Legend of Zelda: Ocarina of Time","The Legend of Zelda: Wind Waker","The Legend of Zelda: Majora's Mask","Half Life","Halo: Combat Evolved","Halo 3","Bioshock","Dragon Quest VIII: Journey of the Cursed King","Dragon Quest XI: Echoes of an Elusive Age","Crash Bandicoot","Spyro the Dragon","Resident Evil 4","Bioshock Infinite","Shadow of the Colossus","Phantasy Star IV: The End of the Millennium","Metal Gear Solid","Kingdom Hearts 2","Metal Gear Solid 2: Sons of Liberty","Metal Gear Solid 3: Snake Eater","Metal Gear Solid 4: Guns of the Patriots","Super Mario Bros. 3","Super Mario World","Super Mario Galaxy","Super Mario 64","Red Dead Redemption","Red Dead Redemption 2","The Last of Us","The Last of Us Part II","Shining Force","Sonic The Hedgehog 2","Sonic The Hedgehog 3","Metaphor: ReFantazio","Hollow Knight","Hollow Knight: Silksong","Dark Souls 3","Dark Souls","Elden Ring","Baldur's Gate 3","Cyberpunk 2077","The Witcher 3: Wild Hunt","The Witcher 2: Assassins of Kings","Fallout: New Vegas","Fallout 3","Vampire Survivors","Borderlands 2","Death Stranding","Ghost of Tsushima","The Elder Scrolls IV: Oblivion","The Elder Scrolls V: Skyrim","Divinity: Original Sin 2","Mass Effect","Mass Effect 2","Mass Effect 3","Thief: Deadly Shadows","Persona 5 Royal","Persona 4 Golden","Persona 3","Disco Elysium","Final Fantasy IX","Final Fantasy X","Final Fantasy VIII","Final Fantasy VII","Final Fantasy VI","God of War (2018)","God of War Ragnarök"
];

const stats = {};
games.forEach(g => stats[g] = { wins: 0, losses: 0, ties: 0 });

let totalVotes = 0;
let champion = null;
let championRepeatCount = 0;
let currentPair = [];
let removedCount = 0;
let previousPairs = new Set();
let protectedGames = [];
let readyToFinish = false;

const leftBtn = document.getElementById('leftBtn');
const rightBtn = document.getElementById('rightBtn');
const tieBtn = document.getElementById('tieBtn');
const battleNumberDiv = document.getElementById('battleNumber');
const removedCountDiv = document.getElementById('removedCount');

function rand(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
function pairKey(a, b) { return [a, b].sort().join('||'); }

function updateProgress() {
  const p = Math.min(100, Math.round((totalVotes / MAX_VOTES) * 100));
  document.getElementById('progress').textContent = `${LANG_TEXTS[LANG].progress} ${p} %`;
  battleNumberDiv.textContent = `${LANG_TEXTS[LANG].battle} ${totalVotes + 1}`;
  removedCountDiv.textContent = `${LANG_TEXTS[LANG].removed}: ${removedCount}`;

  if (totalVotes >= FINAL_BATTLE_START * MAX_VOTES) {
    protectedGames = Object.keys(stats)
      .sort((a, b) => stats[b].wins - stats[a].wins)
      .slice(0, TOP_PROTECTED);
  }

  if (totalVotes >= MIN_VOTES) {
    const ordered = Object.keys(stats)
      .map(g => ({ g, w: stats[g].wins, l: stats[g].losses }))
      .filter(x => x.w + x.l > 0)
      .sort((a, b) => b.w - a.w);

    if (ordered.length >= 5) {
      const gap = ordered[0].w - ordered[4].w;
      if (gap >= 10) readyToFinish = true;
    }
  }

  if (totalVotes >= MAX_VOTES || (readyToFinish && games.length < 2)) {
    showFinalRanking();
  }
}

function removeWeakGames() {
  if (totalVotes >= 0.4 * MAX_VOTES && removedCount === 0) {
    const toRemove = games.filter(g => {
      const played = stats[g].wins + stats[g].losses;
      return played > 0 && (stats[g].wins / played) < REMOVAL_THRESHOLD;
    });
    toRemove.forEach(g => {
      games.splice(games.indexOf(g), 1);
      removedCount++;
    });
  }
}

function pickPair() {
  removeWeakGames();
  if (games.length < 2) return;

  let progress = totalVotes / MAX_VOTES;
  let pair;
  let attempts = 0;

  do {
    if (progress >= FINAL_BATTLE_START) {
      if (!champion) champion = rand(protectedGames);
      const opponent = rand(games.filter(g => g !== champion));
      pair = [champion, opponent];

    } else if (totalVotes >= EXPLORATION_ROUNDS) {
      if (!champion) champion = rand(games);
      const opponent = rand(games.filter(g => g !== champion));
      championRepeatCount++;
      if (championRepeatCount >= MAX_CHAMPION_REPEAT) {
        champion = null;
        championRepeatCount = 0;
      }
      pair = [champion || rand(games), opponent];

    } else {
      let a, b;
      do {
        a = rand(games);
        b = rand(games);
      } while (a === b || previousPairs.has(pairKey(a, b)));
      pair = [a, b];
    }
    attempts++;
  } while (previousPairs.has(pairKey(pair[0], pair[1])) && attempts < 50);

  previousPairs.add(pairKey(pair[0], pair[1]));
  currentPair = pair;
}

function showPair() {
  pickPair();
  if (currentPair.length === 2) {
    leftBtn.textContent = currentPair[0];
    rightBtn.textContent = currentPair[1];
  }
}

function showFinalRanking() {
  leftBtn.style.display = rightBtn.style.display = tieBtn.style.display = 'none';
  const ranking = Object.keys(stats).sort((a, b) => stats[b].wins - stats[a].wins);
  document.getElementById('progress').innerHTML =
    `<h2>${LANG_TEXTS[LANG].finalRanking}</h2><ol>` +
    ranking.map(g => `<li>${g} (${stats[g].wins})</li>`).join('') +
    '</ol>';
}

function vote(winner, loser) {
  stats[winner].wins++;
  stats[loser].losses++;
  totalVotes++;
  champion = winner;
  updateProgress();
  showPair();
}

function tieVote() {
  totalVotes++;
  champion = null;
  championRepeatCount = 0;
  currentPair = [];
  updateProgress();
  showPair();
}

leftBtn.onclick = () => vote(currentPair[0], currentPair[1]);
rightBtn.onclick = () => vote(currentPair[1], currentPair[0]);
tieBtn.onclick = tieVote;
</script>

</body>
</html>
